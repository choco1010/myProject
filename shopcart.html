<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="format-detection" content="telephone=no">
        <title>Sunrise</title>
        <!-- <link rel="icon" href="./img/Group 1.svg"> -->
        <link rel="icon" href="./public/iconimage/flowerlogo.png">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
        <link rel="stylesheet" href="public/font-awesome/6.4.2/css/all.css">
        <link rel="stylesheet" href="public/font-awesome/6.4.2/css/v4-shims.css"> 
        <link rel="stylesheet" href="css/swiper.css">
        <link rel="stylesheet" href="css/shopcart.css">
        <link rel="stylesheet" href="css/shared.css">
        <link href="./public/toastr/toastr.css" rel="stylesheet"/>
        <script src="./js/jquery-3.7.1.min.js"></script> 
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
        <script src="./js/swiper.js"></script>
        <script src="./public/toastr/toastr.js"></script>
        <script src="./js/cartslidbar.js"></script>
        <script src="./js/shareSetting.js"></script>
        <script src="./js/jquery-ui.js"></script>
    </head>
<body>
<!-------------------------------- topMenu Start ----------------------------------->
<header>  
    <div class="topNav">
        <a href="./index.html">
            <h1>Sunrise</h1>
        </a>

        <nav class="textMenu">
            <ul class="navList">
                <li class="navItem"><a href="./aboutus.html">關於我們</a></li>
                <li class="navItem">
                    <a href="#">花藝商品</a>
                    <ul class="productTypes">
                        <li>盆花</li>
                        <li>花束</li>
                        <li>乾燥花</li>
                        <li>
                            <a href="catalog.html">婚禮系列</a>
                        </li>
                        <li >高架花籃</li>
                    </ul>
                </li>
                <li class="navItem"><a href="faq.html">常見問題</a></li>
                <li class="navItem"><a href="contactus.html">花藝諮詢</a></li>
            </ul>
        </nav>

        <nav class="iconMenu">
            <ul>
                <li class="loginIcon"><a href="./login.html"><i class="fa-solid fa-user"></i></a></li>
                <li class="phoneMenu">
                    <i class="fa-solid fa-bars"></i>
                </li>
                <li><a class="cartIcon"><i class="fa-solid fa-cart-shopping"></i></a></li>
                <li class="valnum"><span>0</span></li>   
            </ul>
        </nav>

        <!-- 遮罩 -->
        <div class="phoneOverlay"></div>
        <!-- 漢堡bar -->
        <div class="phoneblock">
            <div class="menuCloseBlock">
                <a class="menuCloseBtn phoneMenu"><i class="fa-solid fa-arrow-left"></i></a>
                <p>CLOSE</p>
            </div>
            <ul class="phoneList">
                <li class="phoneItem"><a href="./aboutus.html">關於我們</a></li>
                <li class="phoneItem"><a href="./catalog.html">花藝商品</a></li>
                <li class="phoneItem"><a href="./faq.html">常見問題</a></li>
                <li class="phoneItem"><a href="./contactus.html">花藝諮詢</a></li>
                <li class="phoneItem login"><a href="./login.html">會員登入</a></li>
            </ul>
        </div>
    </div>
</header>
<!-------------------------------- topMenu end ----------------------------------->
<!-- 遮罩 -->
<div class="webOverlay"></div>
<!-- cartslidbar -->
<section id="cartslidbarBlock">
    <div class="cartslidbarTitle">
            <a class="cartcloseBtn cartIcon"><i class="fa-solid fa-xmark"></i></a>
            <h4>購物車清單</h4>
    </div>

    <ul class="cartslidbarList">
        <!-- JS抓的資料範例 -->
        <!-- <li class="cartslidbarItem">
            <a href="#"><img src="./img/product_1.jpg" alt="新娘捧花-多彩夏季">
                <div class="cartslidbarPrice">
                    <h3>新娘捧花-多彩夏季</h3>
                    <h4>數量: 1</h4>
                    <p>NT 2,500</p>
                </div>
                <i class="fa-regular fa-trash-can slidbarDel"></i>
            </a>
        </li> -->
    </ul>
    <div style="flex-grow: 1;"></div> 

    <a href="./shopcart.html" class="gotoPayment">前往結帳</a>
</section>
<!-- ------------------購物車清單 end------------------ -->

<!---------------------------------- main ------------------------------------->
    <main class="wrapper">

        <div class="spacer"></div>
<!-- ------------------------ loginBox ---------------------- -->
        <div class="loginBox">
            <a href="login.html" class="loginPrompt">
                <p>已經是會員？</p>
                <p>按此登入</p>
                <p>快速完成結帳</p>
            </a>
        </div>

        <div class="loginBoxPhone">
            <p>已經是會員？</p>
            <a href="login.html">按此登入</a>
        </div>

<!-- ------------------------ cartwrapper ---------------------- -->
        <section class="cartBlock">
            <ul class="cartItemHeaders">
                <li>商品名稱</li>
                <li>價格</li>
                <li>數量</li>
                <li>小計</li>
                <li><!--刪除icon用--></li>
            </ul>

            <ul class="productListWeb">
                <!-- JS自動填入 -->
            </ul>

            <ul class="productListPhone">
                <li class="productItemPhone">
                    <a href="product.html" class="productLinkPhone">
                        <img src="./img/product_1_1.jpg" alt="新娘捧花-多彩夏季">
                    </a>
                    <div class="productTitle">
                        <h3>新娘捧花 多彩夏季</h3>
                        <p>單價 NT$2,500</p>
                        <div class="quantityPhone">
                            <button class="quantityBtn" onclick="quantityChange('sub')" aria-label="減少數量">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                            <input type="text" class="quantityInput" value="1">
                            <button class="quantityBtn" onclick="quantityChange('add')" aria-label="增加數量">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <a aria-label="刪除商品" class="phoneRemove removeProduct">
                        <i class="fa-solid fa-trash-can"></i>
                    </a>
                </li>
            </ul>
           
            <div class="tip">
                <p>此筆訂單會產生</p>
                <p>20</p>
                <p>點紅利點數</p>
            </div>
        </section>
<!-- ------------------------ priceItem ---------------------- -->

        <ul class="priceList">
            <li class="priceDetail">
                <span>小計</span>
                <span>NT$2,500</span>
            </li>
            <li class="priceDetail">
                <span>優惠折扣</span>
                <span>NT$0</span>
            </li>
            <!-- -------------------------- -->
            <li class="separator"></li>
            <li class="priceDetail">
                <span>訂單總計</span>
                <span class="total">NT$4,980</span>
            </li>
        </ul>

        <div class="cartBtn">
            <a href="catalog.html" class="continueShop">繼續選購</a>
            <a href="payment.html" class="toBuy">下一步-計算運費</a>
        </div>
   
 <!-- ------------------------ recentlyView ---------------------- -->  

        <div class="recentlyView">
            <button>最近 <br> 瀏覽</button>
            <ul class="historyList">
                <li class="historyItem">
                    <a href="product.html">
                        <img src="./img/product_1_1.jpg" alt="新娘捧花-繽紛花園">
                    </a>
                </li>
                <li class="historyItem">
                    <a href="#">
                        <img src="./img/product_2.jpg" alt="新娘捧花-繽紛花園">
                    </a>
                </li>
            </ul>
        </div>
    </main>
<!---------------------------------- footer -------------------------------->

    <footer>
        <div class="copyRight">
            <span class="footerInfo">Copyright© 本網站為緯育TibaMe【第91期】前端工程師專業技術養成班學員作品,僅供學習、展示之用途。</span>
            <span class="socialLink">
                <a href="#"><i class="fa-brands fa-square-facebook"></i></a>
                <a href="#"><i class="fa-brands fa-instagram"></i></a>
                <a href="#"><i class="fa-brands fa-line"></i></a>
            </span>
        </div>
    </footer>

    <script>
        function quantityChange(element, mathematics) {
            // 找到當前 li 元素
            let listItem = element.closest('li');
            
            // 在當前 li 元素中查找對應的元素
            let quantityInput = listItem.querySelector('.quantityInput');
            let priceValue = listItem.querySelector('.priceValue');

            // 在當前 li 元素中找到價格
            let unitPriceElement = listItem.querySelector('.unitPrice');
            let flowerPrice = parseFloat(unitPriceElement.innerText.replace('NT$', '').replace(/,/g, ''));
            let currentSubtotal = parseFloat(priceValue.innerText.replace('NT$', '').replace(/,/g, ''));

            // 獲取當前输入数量
            let currentValue = parseInt(quantityInput.value);

            // 根據參數進行数量增减
            if (mathematics === 'add') {
                currentValue += 1;
            } else if (mathematics === 'sub') {
                currentValue -= 1;
                if (currentValue < 1) {
                    currentValue = 1;
                }
            }

            // 計算新的小計
            let newSubtotal = currentValue * flowerPrice;

            // 更新输入数量
            quantityInput.value = currentValue;

            // 更新小計顯示
            priceValue.innerText = 'NT$ ' + newSubtotal.toLocaleString();
        
            // 更新總小計和结算總額
            updateTotal();
        }

        function updateTotal() {
            let subtotals = document.querySelectorAll('.priceValue');
            let total = 0;

            // 计算总小计
            subtotals.forEach(function(subtotal) {
                total += parseFloat(subtotal.innerText.replace('NT$', '').replace(/,/g, ''));
            });

            // 更新小计显示
            let subtotalElement = document.querySelector('.priceList .priceDetail:nth-child(1) span:nth-child(2)');
            subtotalElement.innerText = 'NT$' + total.toLocaleString();

            // 更新结算总额
            let totalPriceElement = document.querySelector('.priceList .total');
            totalPriceElement.innerText = 'NT$' + total.toLocaleString();
        }

        function displayLocalCartItems() {
            // 找到 ul 的列表
            let cartList = document.querySelector('.productListWeb');

            // 從 localStorage 中獲取購物車項目
            let cartItems = JSON.parse(localStorage.getItem('productCards'));
            
            // 如果購物車中有商品
            if (cartItems && cartItems.length > 0) {
                let cartItemHTML = '';

                cartItems.forEach(function(productCard) {
                    cartItemHTML += `
                        <li class="productListItem" 
                            data-id="${productCard.id}" 
                            data-name="${productCard.name}" 
                            data-money="${productCard.price}">
                            <a href="product.html" class="productLink">
                                <img src="${productCard.imgUrl}" alt="${productCard.name}">
                                <p>${productCard.name}</p>
                            </a>
                            <div class="unitPrice">NT$${productCard.price}</div>
                            <div class="quantity">
                                <button class="quantityBtn" onclick="quantityChange(this, 'sub')" aria-label="減少數量">
                                    <i class="fa-solid fa-minus"></i>
                                </button>

                                <input type="text" class="quantityInput" value="${productCard.count}">

                                <button class="quantityBtn" onclick="quantityChange(this, 'add')" aria-label="增加數量">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                            <div class="subTotal priceValue">NT$${(productCard.price * productCard.count).toLocaleString()}</div>
                            <a aria-label="刪除商品" class="webRemove removeProduct">
                                <i class="fa-solid fa-trash-can"></i>
                            </a>
                        </li>`;
                });

                cartList.innerHTML = cartItemHTML;
            }
        }

        $(document).on('click', '.removeProduct', function() {
            // 获取要删除的商品名称
            let productName = $(this).closest('.productListItem').find('p').text();
            let result = confirm("你确定要删除" + productName + "吗?");

            if (result == true) {
                // 更新购物车总数量
                let count = parseInt($('.valnum span').text()) - 1;
                $('.valnum span').text(count);
                if (count === 0) {
                    $('.valnum').hide();
                }

                // 從 localStorage 中获取购物车数据并删除相应商品
                let cartObj = JSON.parse(localStorage.getItem('productCards'));
                let preRemoveId = $(this).closest('.productListItem').data('id');
                let removeObjItem = cartObj.findIndex(item => item.id === preRemoveId);
                if (removeObjItem !== -1) {
                    cartObj.splice(removeObjItem, 1);
                }
                localStorage.setItem('productCards', JSON.stringify(cartObj));

                // 移除相应的商品列表项
                $(this).closest('.productListItem').remove();

                updateTotal();
            }
        });

        displayCartItems();
        displayLocalCartItems();
        updateTotal();
    </script>
</body>
</html>